name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4

    - name: Check Swift Version
      run: swift --version

    - name: Get version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build Release Binary
      run: |
        swift build -c release

        # Create distribution directory
        mkdir -p dist

        # Copy binary
        cp .build/release/osx-bench dist/

        # Strip debug symbols for smaller binary
        strip dist/osx-bench

        # Ad-hoc code sign
        codesign --force --sign - dist/osx-bench

        # Get binary info
        file dist/osx-bench
        ls -lh dist/osx-bench

    - name: Create Archive
      run: |
        cd dist
        tar -czvf osx-bench-macos-arm64.tar.gz osx-bench
        shasum -a 256 osx-bench-macos-arm64.tar.gz > osx-bench-macos-arm64.tar.gz.sha256

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## Apple Silicon Bench ${{ steps.version.outputs.VERSION }}

          Benchmark tool for M1, M2, M3, M4, M5 Apple Silicon Macs.

          ### Download

          | File | Description |
          |------|-------------|
          | `osx-bench-macos-arm64.tar.gz` | CLI binary for Apple Silicon |

          ### Installation

          ```bash
          # Download
          curl -LO "https://github.com/carlosacchi/apple-silicon-bench/releases/download/${{ steps.version.outputs.VERSION }}/osx-bench-macos-arm64.tar.gz"

          # Extract and run
          tar -xzf osx-bench-macos-arm64.tar.gz
          xattr -cr osx-bench  # Remove quarantine
          ./osx-bench run
          ```

          ### Quick Start

          ```bash
          # Full benchmark
          ./osx-bench run

          # Quick benchmark (~10 seconds)
          ./osx-bench run --quick

          # View system info
          ./osx-bench info
          ```

          See [CHANGELOG.md](https://github.com/carlosacchi/apple-silicon-bench/blob/main/CHANGELOG.md) for full release notes.
        files: |
          dist/osx-bench-macos-arm64.tar.gz
          dist/osx-bench-macos-arm64.tar.gz.sha256
        draft: false
        prerelease: false
